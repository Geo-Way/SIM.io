
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe PDF - SIMio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <main class="p-6">
    <button onclick="generarInformePDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mb-4">ðŸ“„ Imprimir PDF</button>
    <div id="reportePDF" class="p-6 w-[1000px]" style="display:none;">
      <h1 class="text-xl font-bold mb-4 text-red-700">ðŸ“„ Informe de Mantenimiento - SIMio</h1>

      <div id="graficoLineaTiempo" class="mb-6"><canvas></canvas></div>
      <div id="graficoPorLinea" class="mb-6"><canvas></canvas></div>
      <div id="graficoEstados" class="mb-6"><canvas></canvas></div>

      <div id="tablaResumen" class="mt-6 text-sm"></div>

      <div class="text-center mt-10 text-xs text-gray-600">
        Â© 2025 GEOWAY, Technology-Based Initiative â€“ IBT. All rights reserved.
      </div>
    </div>
  </main>

  <script>
    const datosMantenimiento = [
      {
        fecha: "2025-04-10", maquina: "Prensa A", linea: "LÃ­nea 1", tecnico: "Carlos",
        tiempo: 2, estadomotor: "Operativo", transmision: "Operativa", hidraulico: "Sin fugas",
        neumatico: "Correcto", electrico: "Funciona bien", sintomas: ["Ruido Anormal", "Humo"],
        observaciones: "Mantenimiento preventivo", estadoaccion: "Reparado"
      },
      {
        fecha: "2025-04-12", maquina: "Cortadora B", linea: "LÃ­nea 2", tecnico: "LucÃ­a",
        tiempo: 3, estadomotor: "Sobrecalentamiento", transmision: "Falla", hidraulico: "Obstruido",
        neumatico: "Desgaste excesivo", electrico: "Sin seÃ±al", sintomas: ["Fugas de LÃ­quido"],
        observaciones: "Falla crÃ­tica detectada", estadoaccion: "Pendiente"
      }
    ];

    async function generarInformePDF() {
      if (!datosMantenimiento.length) return alert("No hay datos para generar el informe.");

      const resumen = datosMantenimiento;
      const fechas = resumen.map(d => d.fecha);
      const fechasAgrupadas = fechas.reduce((acc, f) => {
        acc[f] = (acc[f] || 0) + 1; return acc;
      }, {});
      const fechasOrdenadas = Object.keys(fechasAgrupadas).sort();
      const valoresFechas = fechasOrdenadas.map(f => fechasAgrupadas[f]);

      const porLinea = {}, porEstado = {};
      resumen.forEach(d => {
        porLinea[d.linea || "Sin lÃ­nea"] = (porLinea[d.linea || "Sin lÃ­nea"] || 0) + 1;
        porEstado[d.estadoaccion || "Sin estado"] = (porEstado[d.estadoaccion || "Sin estado"] || 0) + 1;
      });

      const g1 = document.querySelector("#graficoLineaTiempo canvas").getContext("2d");
      const g2 = document.querySelector("#graficoPorLinea canvas").getContext("2d");
      const g3 = document.querySelector("#graficoEstados canvas").getContext("2d");

      new Chart(g1, {
        type: "line",
        data: { labels: fechasOrdenadas, datasets: [{ label: "Mantenimientos por Fecha", data: valoresFechas, borderColor: "red", fill: false }] },
        options: { responsive: false }
      });
      new Chart(g2, {
        type: "bar",
        data: { labels: Object.keys(porLinea), datasets: [{ label: "Por LÃ­nea", data: Object.values(porLinea), backgroundColor: "red" }] },
        options: { responsive: false }
      });
      new Chart(g3, {
        type: "pie",
        data: { labels: Object.keys(porEstado), datasets: [{ label: "Estados", data: Object.values(porEstado) }] },
        options: { responsive: false }
      });

      document.getElementById("tablaResumen").innerHTML = `
        <table style="width:100%; border-collapse:collapse; font-size:10px;">
          <thead style="background:#dc3545; color:white;">
            <tr><th>Fecha</th><th>MÃ¡quina</th><th>LÃ­nea</th><th>TÃ©cnico</th><th>Horas</th>
            <th>Motor</th><th>TransmisiÃ³n</th><th>HidrÃ¡ulico</th><th>NeumÃ¡tico</th>
            <th>ElÃ©ctrico</th><th>SÃ­ntomas</th><th>Observaciones</th><th>Estado</th></tr>
          </thead>
          <tbody>
            ${resumen.map(d => `<tr style="border-bottom:1px solid #ddd;">
              <td>${d.fecha}</td><td>${d.maquina}</td><td>${d.linea}</td><td>${d.tecnico}</td><td>${d.tiempo}</td>
              <td>${d.estadomotor}</td><td>${d.transmision}</td><td>${d.hidraulico}</td><td>${d.neumatico}</td>
              <td>${d.electrico}</td><td>${Array.isArray(d.sintomas) ? d.sintomas.join(", ") : d.sintomas}</td><td>${d.observaciones}</td><td>${d.estadoaccion}</td>
            </tr>`).join('')}
          </tbody>
        </table>`;

      await new Promise(r => setTimeout(r, 1500));

      const element = document.getElementById("reportePDF");
      element.style.display = "block";
      element.style.position = "absolute";
      element.style.left = "-9999px";

      await html2pdf().from(element).set({
        margin: 0.5,
        filename: `informe_mantenimiento_${new Date().toISOString().slice(0, 10)}.pdf`,
        image: { type: "jpeg", quality: 0.95 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "in", format: "a4", orientation: "landscape" }
      }).save();

      element.style.display = "none";
      element.style.position = "";
      element.style.left = "";
    }
  </script>
</body>
</html>
