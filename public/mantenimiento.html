<!-- Archivo completo de mantenimiento.html actualizado -->
<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Mantenimiento</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
const rolUsuario = localStorage.getItem("role") || "viewer";
</script>
<script>
  const rolUsuario = localStorage.getItem("role") || "viewer";
</script>
</head>
<script>
  const rolUsuario = localStorage.getItem("role") || "viewer";

  if (!localStorage.getItem("loggedIn")) {
    alert("Debes iniciar sesi√≥n para acceder.");
    window.location.href = "index.html";
  }
</script>
<body class="bg-gray-100 text-gray-900">
<!-- Aqu√≠ insertamos el header y el formulario como ya los tienes -->
<script>
  const rolUsuario = localStorage.getItem("role") || "viewer";

  if (!localStorage.getItem("loggedIn")) {
    alert("Debes iniciar sesi√≥n para acceder.");
    window.location.href = "index.html";
  }
</script>

<!-- Header Profesional y Responsive -->
<header class="bg-white shadow-md sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
<!-- Logo y t√≠tulo -->
<a class="flex items-center space-x-2" href="index.html">
<img alt="Logo" class="h-10 w-auto" src="https://images.squarespace-cdn.com/content/v1/58a36221d482e9bca4af6eac/34694fc3-6f92-4054-8a58-3776436c00dc/IMG_9869+2.PNG?format=2500w"/>
<span class="text-xl font-bold text-red-600">SIMio</span>
<span class="text-sm text-gray-500 italic ml-4" id="rolVisual">(Rol: <span id="nombreRol">...</span>)</span>
</a>
<!-- Men√∫ para escritorio -->
<nav class="hidden md:flex space-x-6 text-sm font-medium">
<a class="text-gray-700 hover:text-red-600" href="index.html">Home</a>
<a class="text-gray-700 hover:text-red-600" href="inventario.html">Inventario</a>
<a class="text-red-600 hover:text-red-600 font-bold" href="mantenimiento.html">Mantenimiento</a>
<a class="text-gray-700 hover:text-red-600" href="maquinas.html">Diagrama de M√°quinas</a>
<a class="text-gray-500 hover:text-red-600" href="info.html" title="Ver documentaci√≥n"> ‚ÑπÔ∏è </a>
</nav>
<!-- Bot√≥n hamburguesa -->
<button class="md:hidden text-gray-700 focus:outline-none" id="menuToggle">
<svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<!-- Men√∫ para m√≥viles -->
<div class="md:hidden hidden px-4 pb-4" id="mobileMenu">
<a class="block py-2 text-gray-700 hover:text-red-600" href="index.html">Home</a>
<a class="block py-2 text-gray-700 hover:text-red-600" href="inventario.html">Inventario</a>
<a class="block py-2 text-gray-700 hover:text-red-600" href="mantenimiento.html">Mantenimiento</a>
      <a href="maquinas.html" class="block py-2 text-gray-700 hover:text-red-600">Diagrama de M√°quinas</a>
    <a href="info.html" class="block py-2 text-gray-700 hover:text-red-600"> ‚ÑπÔ∏è </a>
</div>
</header>
<main class="max-w-7xl mx-auto mt-10 p-4">
<h2 class="text-lg font-semibold text-gray-700 mb-4">üìÑ Formulario de Mantenimiento</h2>
<form class="grid md:grid-cols-3 gap-4 bg-white p-6 rounded shadow mb-6" enctype="multipart/form-data" id="formMantenimiento">
<input class="p-2 border rounded" name="maquina" placeholder="M√°quina" required=""/>
<input class="p-2 border rounded" name="linea" placeholder="L√≠nea"/>
<input class="p-2 border rounded" name="fecha" type="date"/>
<input class="p-2 border rounded" name="tecnico" placeholder="T√©cnico"/>
<input class="p-2 border rounded" name="tiempo" placeholder="Horas mantenimiento" step="0.1" type="number"/>
<input class="p-2 border rounded" name="observaciones" placeholder="Observaciones"/>
<input id="idMantenimiento" name="id" type="hidden"/>
<!-- Foto -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="fotoman">Subir o Tomar Foto</label>
<input accept="image/*" capture="environment" class="p-2 border rounded w-full" id="fotoman" name="fotoman" type="file"/>
</div>
<!-- Selects -->
<select class="p-2 border rounded" name="estadomotor">
<option value="">Motor</option>
<option>Operativo</option>
<option>Ruido Anormal</option>
<option>Vibraci√≥n</option>
<option>Sobrecalentamiento</option>
<option>Sin funcionamiento</option>
</select>
<select class="p-2 border rounded" name="transmision">
<option value="">Transmisi√≥n</option>
<option>Operativa</option>
<option>Desgaste</option>
<option>Desalineada</option>
<option>Falla</option>
</select>
<select class="p-2 border rounded" name="hidraulico">
<option value="">Hidr√°ulico</option>
<option>Sin fugas</option>
<option>Con fugas</option>
<option>Baja presi√≥n</option>
<option>Obstruido</option>
</select>
<select class="p-2 border rounded" name="neumatico">
<option value="">Neum√°tico</option>
<option>Correcto</option>
<option>Fuga de aire</option>
<option>P√©rdida de presi√≥n</option>
<option>Desgaste excesivo</option>
</select>
<select class="p-2 border rounded" name="electrico">
<option value="">El√©ctrico</option>
<option>Funciona bien</option>
<option>Corto circuito</option>
<option>Sensor fallando</option>
<option>Sin se√±al</option>
</select>
<select class="p-2 border rounded" name="estadoaccion">
<option value="">Estado Acci√≥n</option>
<option>Reparado</option>
<option>Pendiente</option>
<option>En seguimiento</option>
<option>Fuera de servicio</option>
</select>
<!-- Checkboxes -->
<fieldset class="col-span-full space-x-2">
<legend class="font-semibold">S√≠ntomas Encontrados</legend>
<label><input name="sintomas" type="checkbox" value="Ruido Anormal"/> Ruido Anormal</label>
<label><input name="sintomas" type="checkbox" value="Fugas de L√≠quido"/> Fugas de L√≠quido</label>
<label><input name="sintomas" type="checkbox" value="Olor a Quemado"/> Olor a Quemado</label>
<label><input name="sintomas" type="checkbox" value="Corrosi√≥n"/> Corrosi√≥n</label>
<label><input name="sintomas" type="checkbox" value="Vibraci√≥n Excesiva"/> Vibraci√≥n Excesiva</label>
<label><input name="sintomas" type="checkbox" value="Sobrecalentamiento"/> Sobrecalentamiento</label>
<label><input name="sintomas" type="checkbox" value="Humo"/> Humo</label>
<label><input name="sintomas" type="checkbox" value="Desgaste Irregular"/> Desgaste Irregular</label>
</fieldset>
<button class="col-span-full bg-red-600 text-white p-2 rounded hover:bg-red-700" id="btnGuardar" type="submit">Guardar</button>
</form>
<hr class="my-10 border-t-2"/>
<h2 class="text-xl font-semibold text-gray-700 mb-4">üìã Filtrar mantenimientos</h2>
<div class="bg-white p-4 rounded shadow mb-6">
<div class="grid md:grid-cols-6 gap-4 mb-4">
<input class="p-2 border rounded" id="filtroMaquina" placeholder="M√°quina"/>
<input class="p-2 border rounded" id="filtroLinea" placeholder="L√≠nea"/>
<input class="p-2 border rounded" id="filtroTecnico" placeholder="T√©cnico"/>
<input class="p-2 border rounded" id="filtroFechaDesde" type="date"/>
<input class="p-2 border rounded" id="filtroFechaHasta" type="date"/>
<select class="p-2 border rounded" id="filtroEstado">
<option value="">Estado</option>
<option>Reparado</option>
<option>Pendiente</option>
<option>En seguimiento</option>
<option>Fuera de servicio</option>
</select>
</div>
<div class="flex justify-end gap-2">
<button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded" onclick="aplicarFiltros()">Filtrar</button>
<button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded" onclick="limpiarFiltros()">Limpiar</button>
</div>
</div>
<h2 class="text-lg font-semibold text-gray-700 mb-2">Historial de Mantenimientos</h2>
<div class="overflow-x-auto bg-white p-4 rounded shadow">
<table class="min-w-full table-auto text-sm">
<thead class="bg-gray-200">
<tr>
<th class="p-2">Fecha</th>
<th class="p-2">M√°quina</th>
<th class="p-2">L√≠nea</th>
<th class="p-2">T√©cnico</th>
<th class="p-2">Horas</th>
<th class="p-2">Motor</th>
<th class="p-2">Transmisi√≥n</th>
<th class="p-2">Hidr√°ulico</th>
<th class="p-2">Neum√°tico</th>
<th class="p-2">El√©ctrico</th>
<th class="p-2">S√≠ntomas</th>
<th class="p-2">Observaciones</th>
<th class="p-2">Acci√≥n</th>
<th class="p-2">Foto</th>
<th class="p-2">‚úèÔ∏è Editar</th>
<th class="p-2">üóëÔ∏è Eliminar</th>
</tr>
</thead>
<tbody id="tablaMantenimiento"></tbody>
</table>
</div>
<div class="mt-4 flex gap-4">
<button class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded" onclick="window.print()">Imprimir PDF</button>
<button class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded" onclick="exportarCSV()">Exportar CSV</button>
</div>
<script>
if (rolUsuario === "viewer") {
  const btnGuardar = document.getElementById("btnGuardar");
  if (btnGuardar) btnGuardar.style.display = "none";
}
</script>
</main>
<div class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" id="modalFoto">
<img class="max-h-[90vh] max-w-[90vw] border-4 border-white shadow-xl" id="imagenGrande"/>
</div>
<script>
let datosMantenimiento = [];
let idEditando = null;

function aplicarFiltros() {
  const desde = document.getElementById("filtroFechaDesde").value;
  const hasta = document.getElementById("filtroFechaHasta").value;
  const maquina = (document.getElementById("filtroMaquina").value ?? "").toLowerCase();
  const linea = (document.getElementById("filtroLinea").value ?? "").toLowerCase();
  const tecnico = (document.getElementById("filtroTecnico").value ?? "").toLowerCase();
  const estado = (document.getElementById("filtroEstado").value ?? "").toLowerCase();

  const filtrados = datosMantenimiento.filter(row => {
    const fecha = row.fecha ?? "";
    return (!desde || fecha >= desde) &&
           (!hasta || fecha <= hasta) &&
           (!maquina || (row.maquina ?? "").toLowerCase().includes(maquina)) &&
           (!linea || (row.linea ?? "").toLowerCase().includes(linea)) &&
           (!tecnico || (row.tecnico ?? "").toLowerCase().includes(tecnico)) &&
           (!estado || (row.estadoaccion ?? "").toLowerCase().includes(estado));
  });

  renderTabla(filtrados);
}

function limpiarFiltros() {
  document.getElementById("filtroFechaDesde").value = "";
  document.getElementById("filtroFechaHasta").value = "";
  document.getElementById("filtroMaquina").value = "";
  document.getElementById("filtroLinea").value = "";
  document.getElementById("filtroTecnico").value = "";
  document.getElementById("filtroEstado").value = "";
  renderTabla(datosMantenimiento);
}

function renderTabla(data) {
  const tbody = document.getElementById("tablaMantenimiento");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
tr.innerHTML = `
  <td class="p-2">${row.fecha}</td>
  <td class="p-2">${row.maquina}</td>
  <td class="p-2">${row.linea}</td>
  <td class="p-2">${row.tecnico}</td>
  <td class="p-2">${row.tiempo}</td>
  <td class="p-2">${row.estadomotor}</td>
  <td class="p-2">${row.transmision}</td>
  <td class="p-2">${row.hidraulico}</td>
  <td class="p-2">${row.neumatico}</td>
  <td class="p-2">${row.electrico}</td>
  <td class="p-2">${row.sintomas}</td>
  <td class="p-2">${row.observaciones}</td>
  <td class="p-2">${row.estadoaccion}</td>
  <td class="p-2"><button onclick="verFoto('${row.fotoman}')" class="text-blue-600 underline">Ver foto</button></td>
  <td class="p-2 text-center">
    ${rolUsuario === "viewer" ? "" : `<button onclick="editarMantenimiento(${row.id})" class="text-yellow-600 hover:scale-110 transition">‚úèÔ∏è</button>`}
  </td>
  <td class="p-2 text-center">
    ${rolUsuario === "viewer" ? "" : `<button onclick="eliminarMantenimiento(${row.id})" type="button" class="text-red-600 hover:scale-110 transition">üóëÔ∏è</button>`}
  </td>
`;

    tbody.appendChild(tr);
  });
}

function verFoto(ruta) {
  const modal = document.getElementById("modalFoto");
  const img = document.getElementById("imagenGrande");
  img.src = ruta;
  modal.classList.remove("hidden");
  modal.onclick = () => modal.classList.add("hidden");
}

function editarMantenimiento(id) {
  const mantenimiento = datosMantenimiento.find(item => item.id === id);
  if (!mantenimiento) return;

  const form = document.getElementById("formMantenimiento");

  // Asignamos el ID global y al campo oculto
  idEditando = id;
  form.querySelector("#idMantenimiento").value = id;

  // Rellenamos los campos del formulario
  form.maquina.value = mantenimiento.maquina || "";
  form.linea.value = mantenimiento.linea || "";
  form.fecha.value = mantenimiento.fecha?.split("T")[0] || "";
  form.tecnico.value = mantenimiento.tecnico || "";
  form.tiempo.value = mantenimiento.tiempo || "";
  form.observaciones.value = mantenimiento.observaciones || "";

  form.estadomotor.value = mantenimiento.estadomotor || "";
  form.transmision.value = mantenimiento.transmision || "";
  form.hidraulico.value = mantenimiento.hidraulico || "";
  form.neumatico.value = mantenimiento.neumatico || "";
  form.electrico.value = mantenimiento.electrico || "";
  form.estadoaccion.value = mantenimiento.estadoaccion || "";

  // Rellenamos los checkboxes de s√≠ntomas
  const sintomas = Array.isArray(mantenimiento.sintomas) ? mantenimiento.sintomas : [];
  form.querySelectorAll('input[name="sintomas"]').forEach(cb => {
    cb.checked = sintomas.includes(cb.value);
  });

  window.scrollTo({ top: 0, behavior: 'smooth' });
}
  

async function eliminarMantenimiento(id) {
  if (!confirm("¬øEst√°s seguro de eliminar este mantenimiento?")) return;
  try {
    console.log("üß® Eliminando ID:", id);
    const res = await fetch(`https://sim-io.onrender.com/api/mantenimiento/${id}`, {
      method: "DELETE"
    });
    const text = await res.text();
    console.log("üì° Respuesta:", text);
    if (!res.ok) throw new Error(text);
    alert("‚úÖ Eliminado correctamente.");
    cargarMantenimientos();
  } catch (err) {
    console.error("‚ùå Error al eliminar:", err.message);
    alert("Hubo un error al eliminar el mantenimiento:\n" + err.message);
  }
}

 


  
function exportarCSV() {
  let csv = "Fecha,M√°quina,L√≠nea,T√©cnico,Horas,Motor,Transmisi√≥n,Hidr√°ulico,Neum√°tico,El√©ctrico,S√≠ntomas,Observaciones,Acci√≥n,Foto\n";
  datosMantenimiento.forEach(row => {
    csv += `${row.fecha},${row.maquina},${row.linea},${row.tecnico},${row.tiempo},${row.estadomotor},${row.transmision},${row.hidraulico},${row.neumatico},${row.electrico},${row.sintomas},${row.observaciones},${row.estadoaccion},${row.fotoman}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mantenimientos.csv";
  a.click();
  window.URL.revokeObjectURL(url);
}

async function cargarMantenimientos() {
  try {
    const res = await fetch("https://sim-io.onrender.com/api/mantenimiento");
    datosMantenimiento = await res.json();
    renderTabla(datosMantenimiento);
  } catch (err) {
    console.error("Error al cargar mantenimientos:", err);
  }
}


 

window.onload = cargarMantenimientos;

</script>
<!-- funcion para la hamburgesa de Men√∫ para m√≥viles -->
<script>
  const menuToggle = document.getElementById("menuToggle");
  const mobileMenu = document.getElementById("mobileMenu");

  menuToggle.addEventListener("click", () => {
    mobileMenu.classList.toggle("hidden");
  });
  
</script>
<!-- ... (omitido por brevedad, ya est√° bien estructurado) -->
<script>




async function eliminarMantenimiento(id) {
  if (!confirm("¬øEst√°s seguro de eliminar este mantenimiento?")) return;

  try {
    const res = await fetch(`https://sim-io.onrender.com/api/mantenimiento/${id}`, { method: "DELETE" });
    if (!res.ok) throw new Error("Error al eliminar");
    alert("‚úÖ Eliminado correctamente.");
    cargarMantenimientos();
  } catch (err) {
    alert("‚ùå Error al eliminar.");
    console.error(err);
  }
}
</script>

<!-- Modal de edici√≥n *** eliminado -->
<script>
// Comprimir imagen antes de enviar
async function comprimirImagen(file, calidad = 0.6) {
  const bitmap = await createImageBitmap(file);
  const canvas = document.createElement("canvas");
  const MAX_WIDTH = 1024;
  const scale = MAX_WIDTH / bitmap.width;
  canvas.width = MAX_WIDTH;
  canvas.height = bitmap.height * scale;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
  return new Promise((resolve) => {
    canvas.toBlob((blob) => resolve(blob), "image/jpeg", calidad);
  });
}

// Evento del formulario actualizado con compresi√≥n
const formMantenimiento = document.getElementById("formMantenimiento");

if (rolUsuario === "viewer") {
  formMantenimiento.addEventListener("submit", function(e) {
    e.preventDefault();
    alert("No tienes permisos para registrar o editar mantenimientos.");
  });
} else {
  formMantenimiento.addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData();

    // Extraer campos manualmente, ya que se usa la compresi√≥n de imagen
    const fields = [
      "maquina", "linea", "fecha", "tecnico", "tiempo", "observaciones",
      "estadomotor", "transmision", "hidraulico", "neumatico", "electrico", "estadoaccion"
    ];
    fields.forEach(name => {
      formData.append(name, form[name].value);
    });

    // Si se est√° editando, a√±ade el ID
    if (idEditando) {
      formData.append("id", idEditando);
    }

    // Checkbox de s√≠ntomas
    const sintomasSeleccionados = Array.from(form.querySelectorAll('input[name="sintomas"]:checked'))
      .map(cb => cb.value);
    sintomasSeleccionados.forEach(val => formData.append("sintomas", val));

    // Comprimir imagen si hay
    const archivo = form.fotoman.files[0];
    if (archivo) {
      const comprimida = await comprimirImagen(archivo, 0.6);
      formData.append("fotoman", comprimida, archivo.name);
    }


}

</script>
<script>
document.getElementById("nombreRol").innerText = rolUsuario;

if (rolUsuario === "viewer") {
  const btnGuardar = document.getElementById("btnGuardar");
  if (btnGuardar) btnGuardar.style.display = "none";
}

// Asegurar que los botones se rendericen correctamente para admin/tecnico
function renderTabla(data) {
  const tbody = document.getElementById("tablaMantenimiento");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="p-2">${row.fecha}</td>
      <td class="p-2">${row.maquina}</td>
      <td class="p-2">${row.linea}</td>
      <td class="p-2">${row.tecnico}</td>
      <td class="p-2">${row.tiempo}</td>
      <td class="p-2">${row.estadomotor}</td>
      <td class="p-2">${row.transmision}</td>
      <td class="p-2">${row.hidraulico}</td>
      <td class="p-2">${row.neumatico}</td>
      <td class="p-2">${row.electrico}</td>
      <td class="p-2">${row.sintomas}</td>
      <td class="p-2">${row.observaciones}</td>
      <td class="p-2">${row.estadoaccion}</td>
      <td class="p-2"><button onclick="verFoto('${row.fotoman}')" class="text-blue-600 underline">Ver foto</button></td>
      <td class="p-2 text-center">
        ${rolUsuario === "viewer" ? "" : `<button onclick="editarMantenimiento(${row.id})" class="text-yellow-600 hover:scale-110 transition">‚úèÔ∏è</button>`}
      </td>
      <td class="p-2 text-center">
        ${rolUsuario === "viewer" ? "" : `<button onclick="eliminarMantenimiento(${row.id})" type="button" class="text-red-600 hover:scale-110 transition">üóëÔ∏è</button>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
}
</script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const rol = localStorage.getItem("rol") || "viewer";
    const spanRol = document.getElementById("nombreRol");
    if (spanRol) spanRol.textContent = rol;
  });
</script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const spanRol = document.getElementById("nombreRol");
    if (spanRol) {
      const role = localStorage.getItem("role") || "viewer";
      spanRol.textContent = role;
    }
  });
</script>
<!-- Footer final -->
<footer class="bg-gray-600 text-gray-200 text-center py-6 mt-10 text-sm">
<div class="max-w-4xl mx-auto px-4 flex flex-col items-center space-y-2">
<p>¬© 2025 <strong><a class="hover:underline" href="https://geo-way.github.io/GeoWay.io/index.html">GEOWAY</a></strong>, Technology-Based Initiative ‚Äì IBT. All rights reserved.</p>
<img alt="GEOWAY Logo" class="h-8 md:h-6 w-auto" src="https://geo-way.github.io/GeoWay.io/images/Logo5.png"/>
</div>
</footer>
</body>
<script>
async function generarInformePDF() {
  const element = document.getElementById("reportePDF");
  element.style.display = "block";
  element.style.position = "absolute";
  element.style.left = "-9999px";

  const data = window.datosMantenimiento || [];

  const fechas = data.map(d => d.fecha);
  const conteoPorFecha = fechas.reduce((acc, f) => {
    acc[f] = (acc[f] || 0) + 1;
    return acc;
  }, {});
  const fechasOrdenadas = Object.keys(conteoPorFecha).sort();
  const valoresFechas = fechasOrdenadas.map(f => conteoPorFecha[f]);

  const porLinea = {}, porEstado = {};
  data.forEach(d => {
    const linea = d.linea || "Desconocida";
    const estado = d.estadoaccion || "Sin estado";
    porLinea[linea] = (porLinea[linea] || 0) + 1;
    porEstado[estado] = (porEstado[estado] || 0) + 1;
  });

  const tabla = document.getElementById("tablaResumen");
  tabla.innerHTML = `<table class="table-auto border w-full text-xs">
    <thead class="bg-gray-200"><tr>
      <th>Fecha</th><th>M√°quina</th><th>L√≠nea</th><th>T√©cnico</th><th>Horas</th>
      <th>Motor</th><th>Transmisi√≥n</th><th>Hidr√°ulico</th><th>Neum√°tico</th>
      <th>El√©ctrico</th><th>S√≠ntomas</th><th>Observaciones</th><th>Acci√≥n</th>
    </tr></thead>
    <tbody>
      ${data.map(d => `
        <tr class="border-t">
          <td>${d.fecha}</td><td>${d.maquina}</td><td>${d.linea}</td><td>${d.tecnico}</td><td>${d.tiempo}</td>
          <td>${d.estadomotor}</td><td>${d.transmision}</td><td>${d.hidraulico}</td><td>${d.neumatico}</td>
          <td>${d.electrico}</td><td>${d.sintomas}</td><td>${d.observaciones}</td><td>${d.estadoaccion}</td>
        </tr>`).join('')}
    </tbody>
  </table>`;

  const ctx1 = document.createElement("canvas");
  const ctx2 = document.createElement("canvas");
  const ctx3 = document.createElement("canvas");
  document.getElementById("graficoLineaTiempo").innerHTML = ""; document.getElementById("graficoLineaTiempo").appendChild(ctx1);
  document.getElementById("graficoPorLinea").innerHTML = ""; document.getElementById("graficoPorLinea").appendChild(ctx2);
  document.getElementById("graficoEstados").innerHTML = ""; document.getElementById("graficoEstados").appendChild(ctx3);

  new Chart(ctx1, {
    type: 'line',
    data: { labels: fechasOrdenadas, datasets: [{ label: 'Mantenimientos por fecha', data: valoresFechas }] }
  });
  new Chart(ctx2, {
    type: 'bar',
    data: { labels: Object.keys(porLinea), datasets: [{ label: 'Mantenimientos por l√≠nea', data: Object.values(porLinea) }] }
  });
  new Chart(ctx3, {
    type: 'pie',
    data: { labels: Object.keys(porEstado), datasets: [{ label: 'Distribuci√≥n de estados', data: Object.values(porEstado) }] }
  });

  await new Promise(resolve => setTimeout(resolve, 1500));

  const options = {
    margin: 0.5,
    filename: `informe_mantenimiento_${new Date().toISOString().slice(0, 10)}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
  };

  await html2pdf().from(element).set(options).save();
  element.style.display = "none";
  element.style.position = "";
  element.style.left = "";
}
</script></body></html>
