<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagrama de M√°quinas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center space-x-2">
        <img src="https://images.squarespace-cdn.com/content/v1/58a36221d482e9bca4af6eac/34694fc3-6f92-4054-8a58-3776436c00dc/IMG_9869+2.PNG?format=2500w" alt="Logo" class="h-10 w-auto" />
        <span class="text-xl font-bold text-red-600">SIMio</span>
      </a>
      <nav class="hidden md:flex space-x-6 text-sm font-medium">
        <a href="index.html" class="text-gray-700 hover:text-red-600">Home</a>
        <a href="inventario.html" class="text-gray-700 hover:text-red-600">Inventario</a>
        <a href="mantenimiento.html" class="text-gray-700 hover:text-red-600">Mantenimiento</a>
        <a href="maquinas.html" class="text-red-600 font-bold">Diagrama de M√°quinas</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto mt-10 px-4">
    <h1 class="text-xl font-bold mb-4">üìç Diagrama de M√°quinas</h1>
    <div id="map" class="w-full h-[80vh] rounded shadow"></div>
  </main>

  <footer class="bg-gray-600 text-gray-200 text-center py-6 mt-10 text-sm">
    <div class="max-w-4xl mx-auto px-4 flex flex-col items-center space-y-2">
      <p>¬© 2025 <strong>GEOWAY</strong>, Technology-Based Initiative ‚Äì IBT. All rights reserved.</p>
      <a href="https://geo-way.github.io/GeoWay.io/index.html" target="_blank" class="hover:opacity-80 transition-opacity">
        <img src="https://geo-way.github.io/GeoWay.io/images/Logo5.png" alt="GEOWAY Logo" class="h-8 invert">
      </a>
    </div>
  </footer>

<script>
const estadoColores = {
  "Reparado": "green",
  "Pendiente": "yellow",
  "En seguimiento": "orange",
  "Fuera de servicio": "red"
};

const maquinas = [
  { nombre: "PISTOLA CUADROS", coords: [892, 206], manual: "https://kalixxe.github.io/Manuales/PISTOLA_CUADROS.pdf" },
  { nombre: "PISTOLA SEMIFLEX", coords: [822, 206], manual: "https://kalixxe.github.io/Manuales/PISTOLA_SEMIFLEX.pdf" },
  { nombre: "PISTOLA CERRAR", coords: [750, 206], manual: "https://kalixxe.github.io/Manuales/PISTOLA_CERRAR.pdf" },
  { nombre: "EMBALADORA 2 TK381", coords: [120, 390], manual: "https://kalixxe.github.io/Manuales/EMBALADORA_2_TK381.pdf" },
  { nombre: "BOX TK386", coords: [690, 170], manual: "https://kalixxe.github.io/Manuales/BOX_TK386.pdf" },
  { nombre: "PORTER", coords: [770, 575], manual: "https://kalixxe.github.io/Manuales/PORTER.pdf" },
  { nombre: "CORTE BOBINAS", coords: [900, 655], manual: "https://kalixxe.github.io/Manuales/CORTE_BOBINAS.pdf" },
  { nombre: "CORTE PANTASOTA", coords: [770, 650], manual: "https://kalixxe.github.io/Manuales/CORTE_PANTASOTA.pdf" },
  { nombre: "QUILTING HC 3500 BANDAS1", coords: [800, 420], manual: "https://kalixxe.github.io/Manuales/QUILTING_HC_3500_BANDAS1.pdf" },
  { nombre: "QUILTING HC 3500 BANDAS2", coords: [800, 335], manual: "https://kalixxe.github.io/Manuales/QUILTING_HC_3500_BANDAS2.pdf" }
];

const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -1,
  maxZoom: 2,
  zoomControl: true
});

const bounds = [[0, 0], [1300, 1600]];
const image = L.imageOverlay('img/layout_horizontal.png', bounds).addTo(map);
map.setView([600, 750], 0);

L.control.attribution({
  position: 'bottomleft',
  prefix: '<img src="https://geo-way.github.io/GeoWay.io/images/Logo5.png" alt="GEOWAY" style="height:20px;vertical-align:middle;"> GEOWAY 2025'
}).addTo(map);

async function obtenerDatosMantenimiento(maquina) {
  try {
    const res = await fetch("https://sim-io.onrender.com/api/mantenimiento");
    const data = await res.json();
    const ult = data.find(d => d.maquina?.toLowerCase() === maquina.toLowerCase());
    return {
      estado: ult?.estadoaccion || "Reparado",
      fecha: ult?.fecha?.split("T")[0] || "-"
    };
  } catch (err) {
    console.warn("Error obteniendo datos de", maquina);
    return { estado: "Reparado", fecha: "-" };
  }
}

maquinas.forEach(async ({ nombre, coords, manual }) => {
  const { estado, fecha } = await obtenerDatosMantenimiento(nombre);
  const color = estadoColores[estado] || "gray";
  const icon = L.circleMarker(coords, {
    radius: 10,
    color: color,
    fillColor: color,
    fillOpacity: 0.9
  }).addTo(map);

  const encoded = encodeURIComponent(nombre);
  icon.bindPopup(`
    <div class="text-sm">
      <p class="font-bold">üîß ${nombre}</p>
      <p class="text-xs text-gray-600">üóìÔ∏è √öltimo mantenimiento: ${fecha}</p>
      <a href="${manual}" target="_blank" class="text-blue-600 underline block mt-1">üì• Descargar manual</a>
      <a href="mantenimiento.html?maquina=${encoded}" class="text-blue-600 underline block">üîß Ver mantenimientos</a>
    </div>
  `);
});
</script>

</body>
</html>
